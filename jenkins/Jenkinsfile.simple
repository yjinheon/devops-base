pipeline {
    agent any
    environment {
        // uv
        UV_CACHE_DIR = "${WORKSPACE}/.uv-cache"
        UV_PROJECT_ENVIRONMENT = "${WORKSPACE}/.venv"
        PATH = "$HOME/.cargo/bin:$PATH"
        // gitlab
        GITLAB_REPO_URL = "http://192.168.0.12:8929/jinheonyoon/llm-backend.git"
        GITLAB_SERVER = "192.168.0.12"
        // app
        APP_PORT = "5000"
        APP_HOST = "0.0.0.0"
        APP_ENV = "production"
    }
    
    triggers {
        // 매일 새벽 4시 (서울 시간) 자동 실행
        cron('TZ=Asia/Seoul\n0 4 * * *')
    }
    
    stages {
        stage('01 Clone Git Repository') {
            steps {

                git branch: 'main', 
                    credentialsId: 'gitlab_token_jh', 
                    url: "${env.GITLAB_REPO_URL}"
            }
        }
        
       stage('02 Code Validataion') {
            steps {
                sh '''
                echo "=== Code Validation ==="
                echo "Checking Python syntax..."
                # use mypy ...
       
                # check  project files
                echo "Checking project files..."
                [ -f "pyproject.toml" ] && echo "✓ pyproject.toml found" || echo "⚠ pyproject.toml missing"
                [ -f "uv.lock" ] && echo "✓ uv.lock found" || echo "⚠ uv.lock missing"
                
                echo "Validation completed - ready for deployment"
                echo "Environment setup completed"
                '''
            }
        }
        
        stage('02 Simple SSH Test') {
            steps {
                sshPublisher(publishers: [sshPublisherDesc(
                    configName: 'Dev-Server',
                    transfers: [sshTransfer(
                        execCommand: '''
                        echo "=== Simple SSH Test ==="
                        echo "Current user: $(whoami)"
                        echo "Current directory: $(pwd)"
                        echo "Home directory: $HOME"
                        echo "Python version: $(python3 --version)"
                        
                        # 디렉토리 확인
                        echo "Checking target directory..."
                        ls -ld /app/ 2>/dev/null || echo "/app not found"
                        ls -ld /app/llm/backend 2>/dev/null || echo "/app/llm/backend not found"
                        ls -ld /app/llm/backend 2>/dev/null || echo "/app/llm/backend not found"
                        
                        # 디렉토리 생성 시도
                        echo "Creating directories if needed..."
                        sudo mkdir -p /app/llm/backend || mkdir -p /app/llm/backend || echo "Cannot create directory"
                        
                        echo "=== SSH Test Completed ==="
                        ''',
                        execTimeout: 60000
                    )]
                )])
            }
        }
            
            
        stage('03 File Transfer Test') {
            steps {
                sshPublisher(publishers: [sshPublisherDesc(
                    configName: 'Dev-Server',
                    transfers: [sshTransfer(
                        sourceFiles: 'app/main.py,server.py,pyproject.toml',
                        remoteDirectory: '/app/scv/cc-scv',
                        execCommand: '''
                        echo "=== File Transfer Test ==="
                        cd /app/scv/cc-scv
                        echo "Files in directory:"
                        ls -la
                        echo "=== Transfer Test Completed ==="
                        ''',
                        execTimeout: 60000
                    )]
                )])
            }
        }
     
    }
      

}
